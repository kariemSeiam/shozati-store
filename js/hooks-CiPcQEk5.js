import{r as e,a8 as t,j as r}from"./vendor-react-BJ-jiNb_.js";const a="https://shozati.pythonanywhere.com/api",s="token",n="userPhone",o="authData",c=e=>{localStorage.setItem(o,JSON.stringify(e))},l=()=>localStorage.getItem(s),u=()=>localStorage.getItem(n),i=()=>{localStorage.removeItem(s),localStorage.removeItem(n),localStorage.removeItem(o)},d=(e=!1,t=!1)=>{const r={"Content-Type":"application/json"};if(e)if(t){const e=localStorage.getItem("adminToken");e&&(r.Authorization=`Bearer ${e}`)}else{const e=l();e&&(r.Authorization=`Bearer ${e}`)}return r},g=new Map,p=async(e,t={},r=!1,s=!1)=>{const n=((e,t)=>{const{method:r="GET",body:a}=t;return`${r}-${e}-${a?JSON.stringify(a):""}`})(e,t),o=g.get(n),c=Date.now();if(o&&c-o.timestamp<1e3)return o.data;try{const o=await fetch(`${a}${e}`,{...t,credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json",...t.headers,...d(r,s)},mode:"cors"});if(!o.ok){const e=await o.json();throw new Error(e.message||"Network response was not ok")}const l=await o.json();return g.set(n,{data:l,timestamp:c}),l}catch(l){throw"Token is invalid or expired"===l.message&&(i(),window.location.href="/login"),l}},m=e.createContext({isAuthenticated:!1,userInfo:null,phone:null,login:()=>{},logout:()=>{},updateProfile:()=>{},addAddress:()=>{},updateAddress:()=>{},loading:!0}),f=e.createContext({cart:[],isCartOpen:!1,setIsCartOpen:()=>{},addToCart:()=>{},removeFromCart:()=>{},updateQuantity:()=>{},emptyCart:()=>{},cartTotal:0}),y=e=>e?.response?.data?.message?e.response.data.message:"An error occurred. Please try again.",h=()=>{const[r,a]=e.useState(!1),[s,n]=e.useState(null),[o,c]=e.useState(null),{isAuthenticated:l}=e.useContext(m),u=e.useRef(null),i=e.useRef({validations:new Map,expiryTime:3e5}),d=e.useCallback(()=>{c(null)},[]),g=e.useCallback((e,t)=>{const r=`${e}-${t}`,a=i.current.validations.get(r);return!(!a||Date.now()-a.timestamp>i.current.expiryTime&&(i.current.validations.delete(r),1))},[]),f=e.useCallback((e,t)=>{const r=`${e}-${t}`;return i.current.validations.get(r)?.data},[]),y=e.useCallback((e,t,r)=>{const a=`${e}-${t}`;i.current.validations.set(a,{data:r,timestamp:Date.now()})},[]),h=e.useCallback(async(e,r)=>{if(!l)return t.error("Please login first"),null;if(!e||!r)return c("Invalid coupon or subtotal"),null;if(u.current&&u.current.abort(),g(e,r)){const t=f(e,r);return n(t),t}a(!0),c(null);try{const t=new AbortController;u.current=t;const a=await p("/coupons/validate",{method:"POST",body:JSON.stringify({code:e.trim(),subtotal:r}),signal:t.signal},!0);return y(e,r,a),c(a),n(a),c(null),a}catch(s){if("AbortError"===s.name)return null;const e=s.message||"Failed to validate coupon";return c(e),n(null),t.error(e),null}finally{a(!1),u.current=null}},[l,g,f,y]),w=e.useCallback(e=>s?"percentage"===s.discountType?Math.round(e*s.discountValue/100*100)/100:Math.min(s.discountValue,e):0,[s]),P=e.useCallback(()=>{n(null),c(null)},[]);return e.useEffect(()=>{l||(P(),i.current.validations.clear())},[l,P]),{currentCoupon:s,validatingCoupon:r,error:o,validateCoupon:h,calculateDiscount:w,clearCoupon:P,clearError:d}},w=(t={})=>{const[r,s]=e.useState([]),[n,o]=e.useState(null),[c,l]=e.useState(0),[u,i]=e.useState(0),[d,g]=e.useState(1),[p]=e.useState(150),[m,f]=e.useState({category:"all",search:"",minPrice:null,maxPrice:null,size:"",color:"",code:"",sort:"popular"}),[y,h]=e.useState({isLoading:!1,isCreating:!1,isUpdating:!1,isDeleting:!1,isUploadingImages:!1}),[w,P]=e.useState({fetchError:null,createError:null,updateError:null,deleteError:null,uploadError:null}),C=e.useRef(null),S=e.useRef(new Map),b=e.useCallback((e,t)=>{h(r=>({...r,[e]:t}))},[]),v=e.useCallback((e,t)=>{P(r=>({...r,[e]:t}))},[]),k=e.useCallback(async(e,t={})=>{C.current&&C.current.abort(),C.current=new AbortController;const r={"Content-Type":"application/json",...t.headers||{}};try{const s=e.startsWith("/")?e.slice(1):e,n=`${a}/${s}`,o=await fetch(n,{...t,headers:r,signal:C.current.signal});if(!o.ok){const e=await o.json().catch(()=>({message:"Unknown error occurred"}));throw new Error(e.message||"API request failed")}return await o.json()}catch(s){if("AbortError"===s.name)return null;throw s}},[]),I=e.useCallback((e,t)=>JSON.stringify({page:e,...t}),[]),O=e.useCallback(async(e=d,t=m)=>{b("isLoading",!0),v("fetchError",null);const r=I(e,t);try{if(S.current.has(r)){const e=S.current.get(r);return s(e.products),l(e.total),i(e.pages),e}const a=new URLSearchParams({page:e,..."all"!==t.category&&{category:t.category},...t.search&&{search:t.search},...t.minPrice&&{minPrice:t.minPrice},...t.maxPrice&&{maxPrice:t.maxPrice},...t.size&&{size:t.size},...t.color&&{color:t.color},...t.code&&{code:t.code},...t.sort&&{sort:t.sort}}).toString(),n=await k(`products?${a}`);if(n)return s(n.products),l(n.total),i(n.pages),S.current.set(r,n),n}catch(a){return v("fetchError",a.message),null}finally{b("isLoading",!1)}},[k,m,I,d,v,b]),E=e.useCallback(async e=>{b("isCreating",!0),v("createError",null);try{const t=await k("/admin/products",{method:"POST",body:JSON.stringify(e)});return t&&(S.current.clear(),await O()),t}catch(t){return v("createError",t.message),null}finally{b("isCreating",!1)}},[k,O,v,b]),T=e.useCallback(async(e,t)=>{b("isUpdating",!0),v("updateError",null);try{const r=await k(`admin/products/${e}`,{method:"PUT",body:JSON.stringify(t)});return r&&(S.current.clear(),await O()),r}catch(r){return v("updateError",r.message),null}finally{b("isUpdating",!1)}},[k,O,v,b]),A=e.useCallback(async e=>{b("isDeleting",!0),v("deleteError",null);try{const t=await k(`admin/products/${e}`,{method:"DELETE"});return t&&(S.current.clear(),await O()),t}catch(t){return v("deleteError",t.message),null}finally{b("isDeleting",!1)}},[k,O,v,b]),$=e.useCallback(async(e,t,r)=>{b("isUploadingImages",!0),v("uploadError",null);try{const a=new FormData;a.append("productCode",e),a.append("colorName",t),r.forEach(e=>{a.append("images",e)});const s=await k("/admin/products/upload-images",{method:"POST",body:a,headers:{"Content-Type":void 0}});return s?.imageUrls||[]}catch(a){return v("uploadError",a.message),[]}finally{b("isUploadingImages",!1)}},[k,v,b]),N=e.useCallback(async(e,t)=>{b("isUpdating",!0),v("updateError",null);try{const r=await k(`admin/products/${e}/inventory`,{method:"PUT",body:JSON.stringify(t)});return r&&(S.current.clear(),await O()),r}catch(r){return v("updateError",r.message),null}finally{b("isUpdating",!1)}},[k,O,v,b]),x=e.useCallback(e=>{f(t=>{const r={...t,...e};return JSON.stringify(t)!==JSON.stringify(r)&&g(1),r})},[]),F=e.useCallback(()=>{d<u&&g(e=>e+1)},[d,u]),J=e.useCallback(()=>{d>1&&g(e=>e-1)},[d]);return e.useEffect(()=>{O()},[O,d,m]),e.useEffect(()=>()=>{C.current&&C.current.abort(),S.current.clear()},[]),{products:r,selectedProduct:n,totalProducts:c,totalPages:u,page:d,perPage:p,filters:m,...y,...w,setSelectedProduct:o,setPage:g,updateFilters:x,fetchProducts:O,createProduct:E,updateProduct:T,deleteProduct:A,uploadProductImages:$,updateInventory:N,nextPage:F,previousPage:J}},P=()=>{const[r,a]=e.useState([]),[s,n]=e.useState(!1),[o,c]=e.useState(null),[l,u]=e.useState({currentPage:1,totalPages:1,hasMore:!1}),{isAuthenticated:i}=e.useContext(m),d=e.useCallback(async(e=1)=>{if(!i)return a([]),void n(!1);try{n(!0);const t=await p(`/orders?page=${e}`,{},!0);a(r=>e>1?[...r,...t.orders]:t.orders),u({currentPage:t.currentPage,totalPages:t.pages,hasMore:t.currentPage<t.pages})}catch(r){c(y(r)),t.error("Failed to load orders")}finally{n(!1)}},[i]),g=e.useCallback(async e=>{if(!i)return t.error("Please login first"),{success:!1,error:"Authentication required"};try{const t=await p("/orders",{method:"POST",body:JSON.stringify(e)},!0);return a(e=>[t.order,...e]),{success:!0,order:t.order}}catch(r){return t.error(y(r)),{success:!1,error:y(r)}}},[i]),f=e.useCallback(async e=>{if(!i)return t.error("Please login first"),!1;try{return await p(`/orders/${e}/cancel`,{method:"POST"},!0),a(t=>t.map(t=>t.id===e?{...t,status:"cancelled"}:t)),!0}catch(r){return t.error(y(r)),!1}},[i]);return e.useEffect(()=>{i?d():(a([]),n(!1))},[d,i]),{orders:r,loading:s,error:o,pagination:l,createOrder:g,cancelOrder:f,fetchOrders:d}},C=()=>{const[r,a]=e.useState([]),[s,n]=e.useState(!0),[o,c]=e.useState(null),l=e.useCallback(async()=>{try{n(!0);const e=await p("/slides",!1);a(e)}catch(e){c(y(e)),t.error("Failed to load slides")}finally{n(!1)}},[]);return e.useEffect(()=>{l()},[l]),{slides:r,loading:s,error:o}},S=()=>{const[r,a]=e.useState([]),[s,n]=e.useState(!1),[o,c]=e.useState(null),{isAuthenticated:l}=e.useContext(m),[u,i]=e.useState(new Map),d=e.useRef(new Set),g=e.useRef(new Map),[f,y]=e.useState({currentPage:1,totalPages:1,totalItems:0,perPage:20}),h=e.useRef({favorites:{data:null,timestamp:0,promise:null,expiryTime:3e5,lastPage:1},status:new Map}),w=e.useCallback(()=>{const{data:e,timestamp:t,expiryTime:r}=h.current.favorites;return e&&Date.now()-t<r},[]),P=e.useCallback(e=>{if(!l||!e)return!1;const t=u.get(e);if(void 0!==t)return t;if(r.some(t=>t.id===e))return!0;const a=h.current.status.get(e);return!!(a&&Date.now()-a.timestamp<h.current.favorites.expiryTime)&&a.status},[l,r,u]),C=e.useCallback(async(e=1)=>{if(l){if(w()&&h.current.favorites.lastPage===e)return h.current.favorites.data;if(h.current.favorites.promise&&h.current.favorites.lastPage===e)return h.current.favorites.promise;try{n(!0);const t=p(`/favorites?page=${e}&perPage=${f.perPage}`,{},!0);h.current.favorites.promise=t;const r=await t;y({currentPage:e,totalPages:r.pages,totalItems:r.total,perPage:f.perPage});const s=r.favorites.map(e=>({...e,isFavorite:u.get(e.id)??!0}));return h.current.favorites={...h.current.favorites,data:s,timestamp:Date.now(),promise:null,lastPage:e},a(s),s}catch(r){throw c(r.message),t.error("Failed to load favorites"),r}finally{n(!1),h.current.favorites.promise=null}}else a([])},[l,f.perPage,w,u]),S=e.useCallback(async e=>{if(!l)return t.error("Please login first"),!1;if(d.current.has(e))return!1;try{d.current.add(e);const r=P(e);i(t=>new Map(t).set(e,!r));const s=await p("/favorites",{method:"POST",body:JSON.stringify({product_id:e})},!0),n=!r;return a(t=>{const r=n?[...t,{id:e,isFavorite:!0}]:t.filter(t=>t.id!==e);return h.current.favorites.data=r,r}),h.current.status.set(e,{status:n,timestamp:Date.now()}),t.success(s.message),!0}catch(r){return i(t=>{const r=new Map(t);return r.delete(e),r}),t.error(r.message),!1}finally{d.current.delete(e),i(t=>{const r=new Map(t);return r.delete(e),r})}},[l,P]),b=e.useCallback(async e=>{if(!l||!e||g.current.has(e))return P(e);try{const t=p(`/favorites/${e}/status`,{},!0);g.current.set(e,t);const r=await t;return h.current.status.set(e,{status:r.isFavorite,timestamp:Date.now()}),r.isFavorite}catch(t){return P(e)}finally{g.current.delete(e)}},[l,P]),v=e.useCallback(()=>(h.current.favorites.timestamp=0,C(f.currentPage)),[C,f.currentPage]);return e.useEffect(()=>{l||(h.current={favorites:{data:null,timestamp:0,promise:null,expiryTime:3e5,lastPage:1},status:new Map},a([]),y({currentPage:1,totalPages:1,totalItems:0,perPage:20}))},[l]),e.useEffect(()=>{l&&C(1)},[l,C]),{favorites:r,loading:s,error:o,pagination:f,fetchFavorites:C,forceFetchFavorites:v,getFavoriteStatus:P,checkFavoriteStatus:b,toggleFavorite:S,isPending:e=>d.current.has(e)}},b=({children:a})=>{const[d,g]=e.useState(!1),[f,h]=e.useState(null),[w,P]=e.useState(u()),[C,S]=e.useState(!0);e.useEffect(()=>{const e=l(),t=u(),r=(()=>{try{return JSON.parse(localStorage.getItem(o))}catch{return null}})();e&&r?(h(r),P(t),g(!0),(async(e=!0)=>{try{const e=await p("/profile",{},!0);h(e),g(!0),c({...e,phone:w})}catch(t){if(i(),g(!1),e){const e=u();e&&await b(e)}}finally{S(!1)}})()):t?b(t):(i(),S(!1))},[]);const b=async e=>{try{const o=await p("/auth/login",{method:"POST",body:JSON.stringify({phone:e})},!1);if(!o.token)throw new Error("Login failed - no token received");r=o.token,localStorage.setItem(s,r),(e=>{localStorage.setItem(n,e)})(e),P(e);try{const[t,r,a]=await Promise.all([p("/profile",{},!0),p("/orders",{},!0),p("/favorites",{},!0)]),s={...t,ordersCount:r.total||0,favoritesCount:a.total||0,orders:r.orders||[],favorites:a.favorites||[],addresses:t.addresses||[],phone:e};return h(s),c(s),g(!0),!0}catch(a){const r={...o.user,ordersCount:0,favoritesCount:0,orders:[],favorites:[],addresses:[],phone:e};return h(r),c(r),g(!0),t.warning("Logged in, but some data could not be loaded"),!0}}catch(o){return i(),g(!1),h(null),P(null),t.error(y(o)),!1}var r};return r.jsx(m.Provider,{value:{isAuthenticated:d,userInfo:f,phone:w,login:b,logout:()=>{i(),g(!1),h(null),P(null)},updateProfile:async e=>{try{const t=await p("/profile",{method:"PUT",body:JSON.stringify(e)},!0),r={...f,...t.user};return h(r),c(r),!0}catch(r){return t.error(y(r)),!1}},addAddress:async e=>{try{const t=await p("/addresses",{method:"POST",body:JSON.stringify(e)},!0),r={...f,addresses:[...f.addresses||[],t.address]};return h(r),c(r),!0}catch(r){return t.error(y(r)),!1}},updateAddress:async(e,r)=>{try{const t=await p(`/addresses/${e}`,{method:"PUT",body:JSON.stringify(r)},!0),a={...f,addresses:f.addresses.map(r=>r.id===e?t.address:r)};return h(a),c(a),!0}catch(a){return t.error(y(a)),!1}},loading:C},children:a})},v=({children:t})=>{const[a,s]=e.useState(()=>{const e=localStorage.getItem("cart");return e?JSON.parse(e):[]}),[n,o]=e.useState(!1);e.useEffect(()=>{localStorage.setItem("cart",JSON.stringify(a))},[a]);const c=a.reduce((e,t)=>e+t.price*t.quantity,0),l=e=>{s(t=>t.filter(t=>t.cartItemId!==e))};return r.jsx(f.Provider,{value:{cart:a,isCartOpen:n,setIsCartOpen:o,addToCart:(e,t,r,a=1)=>{s(s=>{const n=((e,t,r)=>`${e}-${t}-${r}`)(e.id,t.id,r);return s.find(e=>e.cartItemId===n)?s.map(e=>e.cartItemId===n?{...e,quantity:e.quantity+a}:e):[...s,{id:e.id,cartItemId:n,name:e.name,price:e.discountPrice||e.basePrice,image:t.images[0],variantId:t.id,colorName:t.colorName,size:r,quantity:a}]}),o(!0)},removeFromCart:l,updateQuantity:(e,t)=>{t<1?l(e):s(r=>r.map(r=>r.cartItemId===e?{...r,quantity:t}:r))},emptyCart:()=>{s([]),o(!1)},cartTotal:c},children:t})},k={selectedCategory:"all",showProfile:!1,showOrders:!1,showFavorites:!1,showLogin:!1,showLocation:!1,selectedProduct:null,newOrderId:null},I=(t={})=>{const[r,a]=e.useState({...k,...t});return{uiState:r,updateUIState:e.useCallback(e=>{a(t=>({...t,...e}))},[]),toggleModal:e.useCallback((e,t)=>{a(r=>({...r,[e]:t}))},[]),closeModal:e.useCallback(e=>{a(t=>({...t,[e]:!1,..."showOrders"===e?{newOrderId:null}:{},..."selectedProduct"===e?{selectedProduct:null}:{}}))},[]),openModal:e.useCallback((e,t={})=>{a(r=>({...r,[e]:!0,...t}))},[]),selectCategory:e.useCallback(e=>{a(t=>({...t,selectedCategory:e}))},[]),selectProduct:e.useCallback(e=>{a(t=>({...t,selectedProduct:e}))},[]),setOrderId:e.useCallback(e=>{a(t=>({...t,newOrderId:e,showOrders:!0}))},[]),resetToDefault:e.useCallback(()=>{a(k)},[])}},O=()=>{const{isAuthenticated:r,userInfo:a,login:s,updateAddress:n,addAddress:o}=e.useContext(m),[c,l]=e.useState(!1);return{checkAuthAndProceed:e.useCallback((e={})=>{const{requiresAuth:s=!0,requiresAddress:n=!1,onSuccess:o,onNotAuthenticated:c,onNoAddress:l}=e;return s&&!r?(c&&c(),!1):n&&!a?.addresses?.length?(l?l():t.error("يرجى إضافة عنوان التوصيل أولاً"),!1):(o&&o(),!0)},[r,a?.addresses]),handlePhoneVerification:e.useCallback(async e=>{l(!0);try{if(await s(e.phone_number))return{success:!0}}catch(r){throw t.error(r.message||"فشل تسجيل الدخول"),r}finally{l(!1)}},[s]),handleLocationUpdate:e.useCallback(async e=>{l(!0);try{return a?.addresses?.length>0?await n(a.addresses[0].id,{...e,is_default:!0}):await o({...e,is_default:!0}),t.success("تم تحديث العنوان بنجاح"),{success:!0}}catch(r){throw t.error(r.message||"فشل تحديث العنوان"),r}finally{l(!1)}},[a?.addresses,n,o]),isLoading:c,isAuthenticated:r,userInfo:a}},E=({updateFilters:r,setPage:a,selectCategory:s})=>({handleCategorySelect:e.useCallback(e=>{s(e),r({category:"all"===e?"":e,search:"",minPrice:null,maxPrice:null,size:"",color:""}),a(1);const n={women:"حريمي",men:"رجالي",all:"كل المنتجات"}[e]||e;t.loading(`جاري تحميل ${n}...`,{id:"category-loading",duration:1e3})},[r,a,s])});export{m as A,f as C,S as a,P as b,C as c,h as d,b as e,v as f,I as g,O as h,E as i,w as u};
